* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.1 on Nov, 19. 2020. JOBID=0577145999
* 

! Read topology and parameter files
stream toppar_drude.str

! Read PSF and Coordinates
open read unit 10 card name step2_drude.psf
read psf  unit 10 card

open read unit 10 card name step2_drude.crd
read coor unit 10 card

stream step2_drude.str

coor sdrude
coor shake

SHAKE bonh param nofast -
      select  .not. type D*  end -
      select  .not. type D*  end

stream checkfft.str

open read unit 10 card name crystal_image.str
CRYSTAL DEFINE @XTLtype @A @B @C @alpha @beta @gamma
CRYSTAL READ UNIT 10 CARD
image byres xcen 0.0 ycen 0.0 zcen 0.0 sele resn SWM4 end

nbonds atom vatom switch vswitch bycb -
       ctonnb 10.0 ctofnb 12.0 cutnb 16.0 cutim 16.0 LRC -
       inbfrq -1 imgfrq -1 wmin 1.0 cdie eps 1.0 -
       ewald pmew fftx @fftx ffty @ffty fftz @fftz  kappa .34 spline order 6
energy

! first minimize drudes, then entire system
cons harm force 100000. sele .not. type D* end
mini ABNR nstep 100 nprint 20
cons harm force 0.0 sele all end

!
!use positional restraints for equilibration
![you can change the force constant and run longer equilibration (at least 100-200 ps)]
!

define PROT sele @prot end
define CARB sele @carb end

define BB   sele ( ( type C   .or. type O   .or. type N   .or. type CA  .or. -
                     type P   .or. type O1P .or. type O2P .or. type O5' .or. -
                     type C5' .or. type C4' .or. type C3' .or. type O3' ) .and. PROT ) .or. -
                 ( ( type C+ .or. ( type O5 .and. .bonded. type C1 ) .or. ( type O6 .and. .bonded. type C2 ) ) .and. CARB ) end
define SC   sele .not. BB .and. .not. hydrogen .and. ( PROT .or. CARB ) end

cons harm force 1.0 sele BB end
cons harm force 0.1 sele SC end

mini SD   nstep 100 nprint 20
mini ABNR nstep 100 nprint 20

drudehardwall l_wall 0.2

set nstep = 200000
set temp = 303.15

! Set up temperature control for the NPT simulation
bomlev -1
  TPCONTROL NTHER 2  CMDAMP 10.0  NSTEP 20  -
    THER 1 TAU  0.1   TREF @temp  SELECT .NOT. TYPE D* END  -
    THER 2 TAU  0.005 TREF 1.00   SELECT TYPE D* END  -
    BARO   BTAU 0.1   PREF 1.00   DSCY FULL

! open files for restart, trajectory and energies
open write card unit 12 name step4_equilibration.rst
open write file unit 13 name step4_equilibration.dcd

DYNA vv2 start nstep @nstep time 0.0005 ntrfrq @nstep -
     iprfrq 5000 nprint 5000  -
     iasvel -1 firstt @temp finalt @temp -
     iseed 0577145999 -
     iunread -1 iunwrite 12 iuncrd 13 iunvel -1 kunit -1 -
     nsavc 5000 nsavv -1

open write unit 10 card name step4_equilibration.pdb
write coor unit 10 pdb  

open write unit 10 card name step4_equilibration.crd
write coor unit 10 card

stop
